name: E2E Tests

# ============================================================
# E2E Tests: Runs integration tests against a real server
# ============================================================
# Uses Docker Compose to spin up the backend server and runs
# pytest E2E tests against it. Triggered on all PRs.
# ============================================================

on:
  pull_request:

jobs:
  e2e:
    name: E2E Tests
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.14'

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Install dependencies
        run: uv sync --frozen

      - name: Generate Python protos
        run: |
          # Install buf CLI
          curl -sSL https://github.com/bufbuild/buf/releases/latest/download/buf-Linux-x86_64 -o /usr/local/bin/buf
          chmod +x /usr/local/bin/buf
          # Generate Python proto code only (skip TypeScript)
          rm -rf packages/adk-sim-protos/src/adk_sim_protos/adksim packages/adk-sim-protos/src/adk_sim_protos/google
          # Add .venv/bin to PATH so buf can find protoc-gen-python_betterproto
          PATH="$PWD/.venv/bin:$PATH" buf generate --template buf.gen.python.yaml
          # Format generated code (ignore errors on generated code)
          uv run ruff check --fix packages/adk-sim-protos/src/adk_sim_protos 2>/dev/null || true
          uv run ruff format packages/adk-sim-protos/src/adk_sim_protos

      # Note: pytest-docker handles container lifecycle automatically
      # No need to manually start/stop Docker containers

      - name: Run E2E tests
        run: uv run pytest server/tests/e2e --run-e2e -v
