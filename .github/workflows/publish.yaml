name: Publish Packages

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write

jobs:
  # Job 1: Build all packages and verify they're installable
  verify-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup uv
        uses: astral-sh/setup-uv@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: |
          uv sync
          npm ci

      - name: Build Python packages
        run: |
          uv build --package adk-sim-protos --out-dir dist/
          uv build --package adk-sim-testing --out-dir dist/
          uv build --package adk-sim-server --out-dir dist/
          uv build --package adk-agent-sim --out-dir dist/

      - name: Build TypeScript package
        run: npm run build --workspace=packages/adk-sim-protos-ts

      - name: Verify Python installation (local wheels)
        run: |
          uv venv .verify-venv
          # Install leaf package - use local wheels for internal deps, allow external deps from PyPI
          # Note: --prerelease=allow is needed for betterproto>=2.0.0b7
          uv pip install --python .verify-venv adk-sim-server --find-links dist/ --prerelease=allow
          # Smoke test - verify we can import the packages
          .verify-venv/bin/python -c "
          from importlib.metadata import version
          print(f'adk-sim-server: {version(\"adk-sim-server\")}')
          print(f'adk-sim-protos: {version(\"adk-sim-protos\")}')
          # Verify imports work
          import adk_sim_server
          import adk_sim_protos
          print('All imports successful!')
          "

      - name: Upload Python artifacts
        uses: actions/upload-artifact@v4
        with:
          name: python-dist
          path: dist/

  # Job 2: Publish Python packages to PyPI
  publish-pypi:
    needs: verify-build
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Download Python artifacts
        uses: actions/download-artifact@v4
        with:
          name: python-dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          skip-existing: true

  # Job 3: Publish TypeScript package to npm
  publish-npm:
    needs: verify-build
    runs-on: ubuntu-latest
    # No environment - npm trusted publisher configured without environment
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Debug OIDC Token Claims
        run: |
          # Request OIDC token and decode claims for debugging
          OIDC_TOKEN=$(curl -sS -H "Authorization: bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=npm" | jq -r '.value')
          echo "=== OIDC Token Claims ==="
          echo "$OIDC_TOKEN" | cut -d'.' -f2 | base64 -d 2>/dev/null | jq .
          echo "========================="

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install and build
        working-directory: packages/adk-sim-protos-ts
        run: |
          npm ci
          npm run build

      - name: Publish to npm
        working-directory: packages/adk-sim-protos-ts
        run: |
          # Debug: show all npmrc files and their contents
          echo "=== NPM Config Files ==="
          echo "NPM_CONFIG_USERCONFIG: $NPM_CONFIG_USERCONFIG"
          echo "--- ~/.npmrc ---"
          cat ~/.npmrc 2>/dev/null || echo "(not found)"
          echo "--- $NPM_CONFIG_USERCONFIG ---"
          cat "$NPM_CONFIG_USERCONFIG" 2>/dev/null || echo "(not found)"
          echo "--- .npmrc in cwd ---"
          cat .npmrc 2>/dev/null || echo "(not found)"
          echo "========================"
          
          # Remove auth tokens from all possible locations
          sed -i '/_authToken/d' ~/.npmrc 2>/dev/null || true
          sed -i '/_authToken/d' "$NPM_CONFIG_USERCONFIG" 2>/dev/null || true
          
          npm publish --provenance --access public
