# E2E Testing Docker Compose Stack
# =================================
# Full-stack instances (frontend + backend) for E2E testing.
# Mimics production: Python server serves Angular SPA + gRPC API.
#
# Backend Instances:
# - no-sessions: Always empty, never has sessions created
# - populated: Pre-seeded with fixed sessions for stable visual tests
# - shared: Allows session creation for session-specific E2E tests
#
# Usage:
#   docker compose -f docker-compose.e2e.yaml up -d --wait
#
# Each instance runs on a different port (non-conflicting with main docker-compose):
# - no-sessions: 8091 (serves frontend + API)
# - populated:   8092 (serves frontend + API)
# - shared:      8093 (serves frontend + API)

services:
  # ============================================================
  # Instance: no-sessions
  # ============================================================
  # Always empty - tests connecting here should NEVER create sessions.
  # Use for: empty session list tests, "session not found" error tests.
  # ============================================================
  backend-no-sessions:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8091:8080"
    environment:
      PYTHONPATH: /app
      LOG_LEVEL: INFO
      ADK_AGENT_SIM_DATABASE_URL: "sqlite+aiosqlite:///tmp/no-sessions.db"
    command: uv run adk-sim
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 8080)); s.close()"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 10s

  # ============================================================
  # Backend: populated
  # ============================================================
  # Pre-populated with a fixed set of sessions at startup.
  # Tests connecting here should NOT create new sessions.
  # Use for: populated session list screenshots, stable visual regression.
  # ============================================================
  backend-populated:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8092:8080"
    environment:
      PYTHONPATH: /app
      LOG_LEVEL: INFO
      ADK_AGENT_SIM_DATABASE_URL: "sqlite+aiosqlite:///tmp/populated.db"
    command: uv run adk-sim
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 8080)); s.close()"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 10s

  # ============================================================
  # Backend: shared
  # ============================================================
  # Shared backend where session creation is allowed.
  # Multiple tests can run against this safely since each uses
  # its own unique session ID.
  # Use for: session-specific E2E tests.
  # ============================================================
  backend-shared:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "8093:8080"
    environment:
      PYTHONPATH: /app
      LOG_LEVEL: INFO
      ADK_AGENT_SIM_DATABASE_URL: "sqlite+aiosqlite:///tmp/shared.db"
    command: uv run adk-sim
    healthcheck:
      test: ["CMD", "python", "-c", "import socket; s=socket.socket(); s.connect(('localhost', 8080)); s.close()"]
      interval: 2s
      timeout: 5s
      retries: 15
      start_period: 10s
