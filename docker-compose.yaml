services:
  backend:
    build:
      context: .
      dockerfile: docker/backend.Dockerfile
    ports:
      - "50051:50051"
    volumes:
      - ./adk_agent_sim:/app/adk_agent_sim:cached
      - ./logs:/app/logs
      - backend-data:/app/data
    environment:
      - PYTHONPATH=/app
      - LOG_LEVEL=INFO
      - LOG_FILE=/app/logs/coordination-service.log
      # Override default to use the mounted volume path
      - ADK_AGENT_SIM_DATABASE_URL=sqlite+aiosqlite:////app/data/simulator.db
    command: >
      uv run watchfiles
      --filter python
      "python -m adk_agent_sim.server.main"
      /app/adk_agent_sim

  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend.Dockerfile
    ports:
      - "4200:4200"
    volumes:
      - ./frontend:/app:cached
      - /app/node_modules
    command: npx ng serve --host 0.0.0.0 --poll 2000

  envoy:
    image: envoyproxy/envoy:v1.26-latest
    ports:
      - "8080:8080"
    volumes:
      - ./envoy/envoy.yaml:/etc/envoy/envoy.yaml:ro
    depends_on:
      - backend

volumes:
  backend-data:
